services:
  da:
    image: golang:1.22-alpine
    container_name: da
    entrypoint: ["sh", "-c"]
    command:
      - |
        apk add curl perl jq bash git make
        curl -sSL https://rollkit.dev/install-local-da.sh -o start.sh
        sed -i 's|./build/local-da|./build/local-da -listen-all|' start.sh
        bash start.sh
    ports:
      - 7980:7980
  lazychain:
    image: lazychain
    container_name: lazychain
    build:
      context: ../../stride-lazychain
      dockerfile: Dockerfile
    entrypoint: ["sh", "-c"]
    command:
      - |
        until nc -z -v da 7980; do
          echo "Waiting for the DA layer to start..."
          sleep 2
        done
        bash init.sh
    ports:
      - 36657:36657
      - 1317:1317
      - 9290:9290
  relayer:
    container_name: hpl-relayer
    image: gcr.io/abacus-labs-dev/hyperlane-agent:8a66544-20240530-111322
    platform: linux/amd64
    user: root
    # restart: always
    entrypoint: ["sh", "-c"]
    command:
      - |
        rm -rf /app/config/* && \
        cp "/etc/hyperlane/agent-config.docker.json" "/app/config/agent-config.json" && \
        CONFIG_FILES="/etc/hyperlane/relayer.json" \
          ./relayer
    ports:
      - 9110:9090
    volumes:
      - ./hyperlane:/etc/hyperlane
      - ./relayer:/etc/data
      - ./validator:/etc/validator

  validator-lazychain:
    container_name: hpl-validator-lazychain
    image: gcr.io/abacus-labs-dev/hyperlane-agent:8a66544-20240530-111322
    platform: linux/amd64
    user: root
    # restart: always
    entrypoint: ["sh", "-c"]
    command:
      - |
        rm -rf /app/config/* && \
        cp "/etc/hyperlane/agent-config.docker.json" "/app/config/agent-config.json" && \
        CONFIG_FILES="/etc/hyperlane/validator.lazychain.json" \
          ./validator
    ports:
      - 9120:9090
    volumes:
      - ./hyperlane:/etc/hyperlane
      - ./validator:/etc/validator
      - ./validator/lazychain:/etc/data

  validator-strideinternal1:
    container_name: hpl-validator-strideinternal1
    image: gcr.io/abacus-labs-dev/hyperlane-agent:8a66544-20240530-111322
    platform: linux/amd64
    user: root
    # restart: always
    entrypoint: ["sh", "-c"]
    command:
      - |
        rm -rf /app/config/* && \
        cp "/etc/hyperlane/agent-config.docker.json" "/app/config/agent-config.json" && \
        CONFIG_FILES="/etc/hyperlane/validator.strideinternal1.json" \
          ./validator
    ports:
      - 9121:9090
    volumes:
      - ./hyperlane:/etc/hyperlane
      - ./validator:/etc/validator
      - ./validator/strideinternal1:/etc/data

